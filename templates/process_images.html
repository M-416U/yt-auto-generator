{% extends 'base.html' %}

{% block content %}
<div class="bg-white shadow-md rounded-lg p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">Process Images for "{{ video.title }}"</h2>
    
    <div class="mb-6 flex justify-between items-center">
        <p class="text-sm text-gray-600">Review, regenerate, or adjust animation settings for each image.</p>
        <a href="{{ url_for('generate_audio', video_id=video.id) }}" 
           class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            <i class="fas fa-volume-up mr-2"></i>Continue to Audio Generation
        </a>
    </div>
    
    <div id="image-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for image in video.images %}
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-center">
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">Image {{ image.order + 1 }}</span>
                    </div>
                </div>
                
                <div class="p-4">
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                <i class="fas fa-image mr-2"></i>Prompt:
                            </label>
                            <div class="flex space-x-2">
                                <textarea id="prompt_{{ image.id }}" rows="2"
                                          class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">{{ image.prompt }}</textarea>
                                <button onclick="updatePrompt({{ image.id }})"
                                        class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center border border-gray-200 rounded-lg bg-white p-4">
                            {% if image.file_path %}
                                <img src="/{{ image.file_path }}" alt="Generated image" class="w-full h-48 object-contain mb-4">
                                <button onclick="regenerateImage({{ image.id }})"
                                        class="w-full px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                                    <i class="fas fa-sync-alt mr-2"></i>Regenerate Image
                                </button>
                            {% else %}
                                <div class="flex flex-col items-center justify-center h-48 w-full">
                                    <i class="fas fa-image text-gray-300 text-5xl mb-4"></i>
                                    <p class="text-gray-500 mb-4">Image not generated yet</p>
                                    <button onclick="generateImage({{ image.id }})"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                        <i class="fas fa-magic mr-2"></i>Generate Image
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                <i class="fas fa-film mr-2"></i>Animation Type:
                            </label>
                            <div class="flex space-x-2">
                                <select id="animation_{{ image.id }}"
                                        class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="fade" {% if image.animation_type == 'fade' %}selected{% endif %}>Fade</option>
                                    <option value="zoom_in" {% if image.animation_type == 'zoom_in' %}selected{% endif %}>Zoom In</option>
                                    <option value="zoom_out" {% if image.animation_type == 'zoom_out' %}selected{% endif %}>Zoom Out</option>
                                    <option value="slide_left" {% if image.animation_type == 'slide_left' %}selected{% endif %}>Slide Left</option>
                                    <option value="slide_right" {% if image.animation_type == 'slide_right' %}selected{% endif %}>Slide Right</option>
                                </select>
                                <button onclick="updateAnimation({{ image.id }})"
                                        class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div class="mt-6 flex justify-end">
        <a href="{{ url_for('generate_audio', video_id=video.id) }}" 
           class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            <i class="fas fa-volume-up mr-2"></i>Continue to Audio Generation
        </a>
    </div>
    
    <script>
        function generateImage(imageId) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            button.disabled = true;
            
            fetch(`/video/{{ video.id }}/regenerate_image/${imageId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to generate image: ' + data.error);
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
        
        function regenerateImage(imageId) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerating...';
            button.disabled = true;
            
            const prompt = document.getElementById(`prompt_${imageId}`).value;
            
            fetch(`/video/{{ video.id }}/regenerate_image/${imageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `prompt=${encodeURIComponent(prompt)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to regenerate image: ' + data.error);
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
        
        function updateAnimation(imageId) {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            const animationType = document.getElementById(`animation_${imageId}`).value;
            
            fetch(`/video/{{ video.id }}/update_image_animation/${imageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `animation_type=${encodeURIComponent(animationType)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success indicator
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }, 1000);
                } else {
                    alert('Failed to update animation');
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
        }
        
        function updatePrompt(imageId) {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            const prompt = document.getElementById(`prompt_${imageId}`).value;
            
            fetch(`/video/{{ video.id }}/update_image_prompt/${imageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `prompt=${encodeURIComponent(prompt)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success indicator
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }, 1000);
                } else {
                    alert('Failed to update prompt');
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
        }
    </script>
{% endblock %}