{% extends 'base.html' %} {% block title %}Upload to YouTube{% endblock %} {%
block content %}
<div class="bg-white shadow-md rounded-lg p-6">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">Upload to YouTube</h2>

  <div class="bg-white shadow-md rounded-lg mb-6">
    <div class="border-b border-gray-200 px-4 py-3">
      <h3 class="text-lg font-semibold text-gray-800">Content Details</h3>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="text-xl font-medium text-gray-800 mb-2">
            {{ content.title }}
          </h4>
          <p class="text-gray-600 mb-4">{{ content.description }}</p>
          {% if is_short %}
          <p class="text-gray-700">
            <strong>Duration:</strong> {{ content.duration_seconds }} seconds
          </p>
          {% else %}
          <p class="text-gray-700">
            <strong>Topic:</strong> {{ content.topic }}
          </p>
          <p class="text-gray-700">
            <strong>Duration:</strong> {{ content.duration }} seconds
          </p>
          {% endif %}
        </div>
        <div>
          {% if is_short %} {% set video_src ='/output/' + content.output_file
          %} {% else %} {% set video_src = '/output/video_' ~ content.id ~
          '_with_subs.mp4' %} {% endif %} {% include
          'components/video_player.html' with context %}
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white shadow-md rounded-lg">
    <div class="border-b border-gray-200 px-4 py-3">
      <h3 class="text-lg font-semibold text-gray-800">Upload Settings</h3>
    </div>
    <div class="p-4">
      <form id="uploadForm" class="space-y-4">
        <input type="hidden" id="contentId" value="{{ content.id }}" />
        <input type="hidden" id="contentType" value="{{ content_type }}" />

        <div>
          <label
            for="title"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Title</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="title"
            value="{{ content.title }}"
            required
          />
        </div>

        <div>
          <label
            for="description"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Description</label
          >
          <textarea
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="description"
            rows="4"
            required
          >
{{ content.description }}</textarea
          >
        </div>

        <div>
          <label for="tags" class="block text-sm font-medium text-gray-700 mb-1"
            >Tags (comma separated)</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="tags"
            value="{% if is_short %}{{ content.hashtags }}{% else %}{{ content.topic }}{% endif %}"
          />
        </div>

        <div>
          <label
            for="privacyStatus"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Privacy Status</label
          >
          <select
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="privacyStatus"
          >
            <option value="private">Private</option>
            <option value="unlisted">Unlisted</option>
            <option value="public">Public</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Upload as Short</label
          >
          <div class="flex items-center">
            <input
              type="checkbox"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              id="isShort"
              {%
              if
              is_short
              %}checked{%
              endif
              %}
            />
            <label class="ml-2 text-sm text-gray-700" for="isShort">
              Upload as YouTube Short
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Select YouTube Channels</label
          >
          <div class="space-y-2 border border-gray-200 rounded-md p-2">
            {% for account in accounts %}
            <div class="flex items-center p-2 hover:bg-gray-50 rounded-md">
              <input
                type="checkbox"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded account-checkbox"
                value="{{ account.id }}"
                id="account{{ account.id }}"
              />
              <label
                class="ml-2 text-sm text-gray-700"
                for="account{{ account.id }}"
              >
                {{ account.channel_title }} ({{
                account.subscriber_count|format_number }} subscribers)
              </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <button
          type="submit"
          class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          id="uploadButton"
        >
          Upload to YouTube
        </button>
      </form>

      <div id="uploadStatus" class="mt-6 hidden">
        <h4 class="text-lg font-medium text-gray-800 mb-3">Upload Status</h4>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
          <div
            class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
            style="width: 0%"
            role="progressbar"
          ></div>
        </div>
        <div id="statusMessages"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      // Get selected account IDs
      const accountIds = [];
      document
        .querySelectorAll(".account-checkbox:checked")
        .forEach((checkbox) => {
          accountIds.push(parseInt(checkbox.value));
        });

      if (accountIds.length === 0) {
        alert("Please select at least one YouTube channel");
        return;
      }

      // Prepare data
      const data = {
        content_type: document.getElementById("contentType").value,
        content_id: parseInt(document.getElementById("contentId").value),
        account_ids: accountIds,
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        tags: document.getElementById("tags").value,
        privacy_status: document.getElementById("privacyStatus").value,
        is_short: document.getElementById("isShort").checked,
      };

      // Disable form
      document.getElementById("uploadButton").disabled = true;

      // Show status section
      const statusDiv = document.getElementById("uploadStatus");
      statusDiv.style.display = "block";
      const progressBar = document.querySelector("#uploadStatus .bg-blue-600");
      progressBar.style.width = "10%";

      // Send upload request
      fetch("/api/upload/content", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            progressBar.style.width = "20%";
            document.getElementById(
              "statusMessages"
            ).innerHTML = `<div class="bg-blue-100 text-blue-800 p-4 rounded-md">Upload started for ${accountIds.length} channel(s)</div>`;

            // Start polling for status
            const uploadIds = data.upload_ids;
            pollUploadStatus(uploadIds, data.content_type);
          } else {
            progressBar.style.width = "100%";
            progressBar.classList.remove("bg-blue-600");
            progressBar.classList.add("bg-red-600");
            document.getElementById(
              "statusMessages"
            ).innerHTML = `<div class="bg-red-100 text-red-800 p-4 rounded-md">Error: ${data.error}</div>`;
            document.getElementById("uploadButton").disabled = false;
          }
        })
        .catch((error) => {
          progressBar.style.width = "100%";
          progressBar.classList.remove("bg-blue-600");
          progressBar.classList.add("bg-red-600");
          document.getElementById(
            "statusMessages"
          ).innerHTML = `<div class="bg-red-100 text-red-800 p-4 rounded-md">Error: ${error.message}</div>`;
          document.getElementById("uploadButton").disabled = false;
        });
    });

  function pollUploadStatus(uploadIds, contentType) {
    const progressBar = document.querySelector("#uploadStatus .bg-blue-600");
    const statusDiv = document.getElementById("statusMessages");

    fetch("/api/upload/status", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        type: contentType,
        upload_ids: uploadIds,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          let allCompleted = true;
          let anyFailed = false;
          let statusHtml = "";

          data.statuses.forEach((status) => {
            if (status.status === "pending" || status.status === "uploading") {
              allCompleted = false;
            }

            if (status.status === "failed") {
              anyFailed = true;
            }

            let statusClass = "secondary";
            if (status.status === "completed") statusClass = "success";
            if (status.status === "failed") statusClass = "danger";
            if (status.status === "uploading") statusClass = "primary";

            statusHtml += `<div class="alert alert-${statusClass} mb-2">
                    Upload #${status.id}: ${status.status.toUpperCase()}
                    ${
                      status.youtube_id
                        ? `<a href="https://youtube.com/watch?v=${status.youtube_id}" target="_blank" class="btn btn-sm btn-outline-primary ml-2">View on YouTube</a>`
                        : ""
                    }
                    ${
                      status.error
                        ? `<div class="text-danger mt-1">${status.error}</div>`
                        : ""
                    }
                </div>`;
          });

          statusDiv.innerHTML = statusHtml;

          if (allCompleted) {
            progressBar.style.width = "100%";
            progressBar.classList.remove(
              "progress-bar-animated",
              "progress-bar-striped"
            );
            if (anyFailed) {
              progressBar.classList.add("bg-warning");
            } else {
              progressBar.classList.add("bg-success");
            }
            document.getElementById("uploadButton").disabled = false;
          } else {
            progressBar.style.width = "60%";
            setTimeout(() => pollUploadStatus(uploadIds, contentType), 3000);
          }
        }
      })
      .catch((error) => {
        console.error("Error polling status:", error);
        setTimeout(() => pollUploadStatus(uploadIds, contentType), 5000);
      });
  }
</script>
{% endblock %}
